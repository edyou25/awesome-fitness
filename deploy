#!/bin/bash

# Awesome Fitness éƒ¨ç½²è„šæœ¬
# ç”¨æ³•: ./deploy -r (è¿œç¨‹éƒ¨ç½²) æˆ– ./deploy -l (æœ¬åœ°é¢„è§ˆ)

set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# æ‰“å°å¸¦é¢œè‰²çš„æ¶ˆæ¯
print_info() {
    echo -e "${BLUE}â„¹ï¸  $1${NC}"
}

print_success() {
    echo -e "${GREEN}âœ… $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}âš ï¸  $1${NC}"
}

print_error() {
    echo -e "${RED}âŒ $1${NC}"
}

# æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
show_help() {
    echo "Awesome Fitness éƒ¨ç½²è„šæœ¬"
    echo ""
    echo "ç”¨æ³•:"
    echo "  ./deploy -r    è¿œç¨‹éƒ¨ç½²åˆ°GitHub Pages"
    echo "  ./deploy -l    æœ¬åœ°æ„å»ºå’Œé¢„è§ˆ"
    echo "  ./deploy -h    æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯"
    echo ""
    echo "é€‰é¡¹:"
    echo "  -r, --remote   æ¨é€åˆ°GitHubå¹¶è‡ªåŠ¨éƒ¨ç½²"
    echo "  -l, --local    æœ¬åœ°æ„å»ºå’Œå¯åŠ¨é¢„è§ˆæœåŠ¡å™¨"
    echo "  -h, --help     æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯"
}

# ç”Ÿæˆæäº¤ä¿¡æ¯
generate_commit_message() {
    # è·å–æ›´æ”¹çš„æ–‡ä»¶åˆ—è¡¨
    changed_files=$(git diff --cached --name-only)
    
    # åˆ†ææ›´æ”¹ç±»å‹
    if echo "$changed_files" | grep -q "docs/"; then
        if echo "$changed_files" | grep -q "training-programs.rst"; then
            echo "Update training programs content"
        else
            echo "Update documentation"
        fi
    elif echo "$changed_files" | grep -q "README.md"; then
        echo "Update README"
    elif echo "$changed_files" | grep -q "deploy"; then
        echo "Update deploy script"
    elif echo "$changed_files" | grep -q "TODO.md"; then
        echo "Update TODO list"
    elif echo "$changed_files" | grep -q "conf.py"; then
        echo "Update Sphinx configuration"
    elif echo "$changed_files" | grep -q "requirements.txt"; then
        echo "Update dependencies"
    elif echo "$changed_files" | grep -q ".github/"; then
        echo "Update GitHub Actions workflow"
    else
        # æ ¹æ®æ–‡ä»¶æ•°é‡ç”Ÿæˆä¿¡æ¯
        file_count=$(echo "$changed_files" | wc -l)
        if [ "$file_count" -eq 1 ]; then
            filename=$(basename "$changed_files")
            echo "Update $filename"
        else
            echo "Update multiple files ($file_count files)"
        fi
    fi
}

# æ£€æŸ¥ä¾èµ–
check_dependencies() {
    print_info "æ£€æŸ¥ä¾èµ–..."
    
    # æ£€æŸ¥conda
    if ! command -v conda &> /dev/null; then
        print_error "Condaæœªå®‰è£…æˆ–ä¸åœ¨PATHä¸­"
        exit 1
    fi
    
    # æ£€æŸ¥ielts-envç¯å¢ƒ
    if ! conda env list | grep -q "ielts-env"; then
        print_error "ielts-envç¯å¢ƒä¸å­˜åœ¨"
        exit 1
    fi
    
    # æ£€æŸ¥git
    if ! command -v git &> /dev/null; then
        print_error "Gitæœªå®‰è£…"
        exit 1
    fi
    
    print_success "ä¾èµ–æ£€æŸ¥é€šè¿‡"
}

# æœ¬åœ°æ„å»ºå’Œé¢„è§ˆ
local_deploy() {
    print_info "å¼€å§‹æœ¬åœ°æ„å»ºå’Œé¢„è§ˆ..."
    
    # æ¿€æ´»condaç¯å¢ƒ
    print_info "æ¿€æ´»condaç¯å¢ƒ..."
    source $(conda info --base)/etc/profile.d/conda.sh
    conda activate ielts-env
    
    # è¿›å…¥docsç›®å½•
    cd docs
    
    # æ¸…ç†ä¹‹å‰çš„æ„å»º
    print_info "æ¸…ç†ä¹‹å‰çš„æ„å»º..."
    rm -rf _build/html
    
    # æ„å»ºæ–‡æ¡£
    print_info "æ„å»ºSphinxæ–‡æ¡£..."
    sphinx-build -b html . _build/html
    
    if [ $? -eq 0 ]; then
        print_success "æ–‡æ¡£æ„å»ºæˆåŠŸï¼"
        
        # å¯åŠ¨æœ¬åœ°æœåŠ¡å™¨
        print_info "å¯åŠ¨æœ¬åœ°é¢„è§ˆæœåŠ¡å™¨..."
        print_info "è®¿é—®åœ°å€: http://localhost:8000"
        print_info "æŒ‰ Ctrl+C åœæ­¢æœåŠ¡å™¨"
        echo ""
        
        cd _build/html
        python -m http.server 8000
    else
        print_error "æ–‡æ¡£æ„å»ºå¤±è´¥"
        exit 1
    fi
}

# è¿œç¨‹éƒ¨ç½²
remote_deploy() {
    print_info "å¼€å§‹è¿œç¨‹éƒ¨ç½²..."
    
    # æ£€æŸ¥æ˜¯å¦æœ‰æœªæäº¤çš„æ›´æ”¹
    if ! git diff-index --quiet HEAD --; then
        print_warning "æ£€æµ‹åˆ°æœªæäº¤çš„æ›´æ”¹"
        read -p "æ˜¯å¦è¦æäº¤è¿™äº›æ›´æ”¹? (y/N): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            print_info "æäº¤æ›´æ”¹..."
            git add .
            
            # è‡ªåŠ¨ç”Ÿæˆæäº¤ä¿¡æ¯
            print_info "è‡ªåŠ¨ç”Ÿæˆæäº¤ä¿¡æ¯..."
            commit_msg=$(generate_commit_message)
            print_success "ç”Ÿæˆçš„æäº¤ä¿¡æ¯: $commit_msg"
            
            git commit -m "$commit_msg"
        else
            print_error "å–æ¶ˆéƒ¨ç½²"
            exit 1
        fi
    fi
    
    # æ¨é€åˆ°è¿œç¨‹ä»“åº“
    print_info "æ¨é€åˆ°GitHub..."
    git push origin main
    
    if [ $? -eq 0 ]; then
        print_success "ä»£ç æ¨é€æˆåŠŸï¼"
        print_info "GitHub Actionsæ­£åœ¨è‡ªåŠ¨æ„å»ºå’Œéƒ¨ç½²..."
        print_info "ç½‘ç«™å°†åœ¨2-3åˆ†é’Ÿå†…æ›´æ–°"
        print_info "è®¿é—®åœ°å€: https://edyou25.github.io/awesome-fitness/"
        print_info "æŸ¥çœ‹éƒ¨ç½²çŠ¶æ€: https://github.com/edyou25/awesome-fitness/actions"
    else
        print_error "æ¨é€å¤±è´¥"
        exit 1
    fi
}

# ä¸»å‡½æ•°
main() {
    echo "ğŸš€ Awesome Fitness éƒ¨ç½²è„šæœ¬"
    echo "================================"
    
    # æ£€æŸ¥å‚æ•°
    if [ $# -eq 0 ]; then
        show_help
        exit 1
    fi
    
    # è§£æå‚æ•°
    case $1 in
        -r|--remote)
            check_dependencies
            remote_deploy
            ;;
        -l|--local)
            check_dependencies
            local_deploy
            ;;
        -h|--help)
            show_help
            ;;
        *)
            print_error "æœªçŸ¥å‚æ•°: $1"
            show_help
            exit 1
            ;;
    esac
}

# è¿è¡Œä¸»å‡½æ•°
main "$@"
